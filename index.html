<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Carrera IA F1</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 0; }
    #controls { margin: 20px; }
    canvas { background: #e0e0e0; display: block; margin: 0 auto; border: 2px solid #444; }
  </style>
</head>
<body>
  <h2>Carrera IA F1: Entrena tus coches</h2>
  <div id="controls">
    <label for="numCars">Número de IAs: </label>
    <input id="numCars" type="number" min="1" max="50" value="10" style="width: 60px;">
    <button onclick="entrenar()">Correr carrera</button>
  </div>
  <canvas id="game" width="800" height="400"></canvas>
  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const start = { x: 60, y: 200 };
    const goal = { x: 740, y: 200 };
    const numSteps = 60;

    // --------------------- MENTE GLOBAL ---------------------
    function guardarMenteGlobal(path, distance) {
      localStorage.setItem("menteGlobalPath", JSON.stringify(path));
      localStorage.setItem("menteGlobalDist", distance);
    }
    function cargarMenteGlobal() {
      return {
        path: JSON.parse(localStorage.getItem("menteGlobalPath") || "null"),
        distance: Number(localStorage.getItem("menteGlobalDist") || "Infinity")
      };
    }
    // -------------------------------------------------------

    let bestPath = null;
    let bestDistance = Infinity;

    function drawTrack() {
      ctx.strokeStyle = "#222";
      ctx.lineWidth = 32;
      ctx.beginPath();
      ctx.moveTo(start.x, start.y);
      ctx.lineTo(goal.x, goal.y);
      ctx.stroke();

      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(start.x, start.y - 16);
      ctx.lineTo(goal.x, goal.y - 16);
      ctx.moveTo(start.x, start.y + 16);
      ctx.lineTo(goal.x, goal.y + 16);
      ctx.stroke();

      ctx.fillStyle = "green";
      ctx.fillRect(goal.x - 12, goal.y - 20, 24, 40);
      ctx.fillStyle = "#fff";
      ctx.fillRect(goal.x - 12, goal.y - 20, 24, 10);
      ctx.fillRect(goal.x - 12, goal.y + 10, 24, 10);
    }

    function drawCar(x, y, color, angle = 0) {
      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(angle);
      ctx.fillStyle = color;
      ctx.fillRect(-14, -7, 28, 14);
      ctx.fillStyle = "#222";
      ctx.fillRect(-6, -5, 12, 10);
      ctx.fillStyle = "#555";
      ctx.fillRect(-16, -3, 4, 6);
      ctx.fillRect(12, -3, 6, 6);
      ctx.restore();
    }

    function drawTrail(trail, color) {
      ctx.save();
      ctx.strokeStyle = color;
      ctx.globalAlpha = 0.4;
      ctx.lineWidth = 2;
      ctx.beginPath();
      if (trail.length > 0) {
        ctx.moveTo(trail[0].x, trail[0].y);
        for (let p of trail) ctx.lineTo(p.x, p.y);
      }
      ctx.stroke();
      ctx.globalAlpha = 1;
      ctx.restore();
    }

    function distancia(a, b) {
      return Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
    }

    function randomDirection() {
      const base = 12;
      return [
        { dx: base, dy: 0, da: 0 },
        { dx: base, dy: -4, da: -0.07 },
        { dx: base, dy: 4, da: 0.07 },
        { dx: base, dy: -8, da: -0.12 },
        { dx: base, dy: 8, da: 0.12 }
      ][Math.floor(Math.random() * 5)];
    }

    function generarCoches(n) {
      let coches = [];
      for (let i = 0; i < n; i++) {
        coches.push({
          pos: { x: start.x, y: start.y },
          angle: 0,
          path: [],
          trail: [{ x: start.x, y: start.y }],
          color: `hsl(${(i * 360) / n}, 80%, 50%)`,
          terminado: false,
          score: 0
        });
      }
      return coches;
    }

    function entrenar() {
      const n = parseInt(document.getElementById("numCars").value, 10);
      const generaciones = 10;

      // ¡Cargar la mente global antes de entrenar!
      let mente = cargarMenteGlobal();
      bestPath = mente.path;
      bestDistance = mente.distance;

      function ejecutarGeneracion(gen) {
        let coches = generarCoches(n);
        let paso = 0;

        function moverCoches() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          drawTrack();

          ctx.fillStyle = "#00ff00";
          ctx.fillRect(goal.x - 12, goal.y - 20, 24, 40);

          let algunoMoviendo = false;

          for (let car of coches) {
            if (!car.terminado && paso < numSteps) {
              let dir;
              if (bestPath && Math.random() < 0.7 && bestPath[paso]) {
                dir = bestPath[paso];
              } else {
                dir = randomDirection();
              }
              car.angle += dir.da;
              car.pos.x += dir.dx * Math.cos(car.angle);
              car.pos.y += dir.dx * Math.sin(car.angle) + dir.dy;
              car.path.push({ dx: dir.dx, dy: dir.dy, da: dir.da });
              car.trail.push({ x: car.pos.x, y: car.pos.y });
              if (distancia(car.pos, goal) < 16) car.terminado = true;
              algunoMoviendo = true;
            }
            drawTrail(car.trail, car.color);
            drawCar(car.pos.x, car.pos.y, car.color, car.angle);
          }

          paso++;
          if (algunoMoviendo && paso <= numSteps) {
            requestAnimationFrame(moverCoches);
          } else {
            for (let car of coches) {
              let d = distancia(car.pos, goal);
              if (d < 16) {
                car.score = 1000 - car.trail.length;
              } else {
                car.score = Math.max(0, 500 - d);
              }
            }
            coches.sort((a, b) => b.score - a.score);
            for (let i = coches.length - 3; i < coches.length; i++) {
              if (i >= 0) coches[i].score -= 200;
            }
            if (coches[0].score > 0) {
              // Si aprende algo mejor que la mente global, la actualiza
              if (!bestPath || distancia(coches[0].pos, goal) < bestDistance) {
                bestPath = coches[0].path;
                bestDistance = distancia(coches[0].pos, goal);
                guardarMenteGlobal(bestPath, bestDistance);
              }
            }
            if (gen < generaciones - 1) {
              setTimeout(() => ejecutarGeneracion(gen + 1), 500);
            }
          }
        }
        moverCoches();
      }

      ejecutarGeneracion(0);
    }

    // Pista inicial
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawTrack();
  </script>
</body>
</html>
